{"ast":null,"code":"import { polyfillVertexArrayObject } from './polyfill-vertex-array-object';\nimport { assert } from '../utils/assert';\nimport { WEBGL2_CONTEXT_POLYFILLS, WEBGL2_CONTEXT_OVERRIDES } from './polyfill-table';\nexport function polyfillContext(gl) {\n  gl.luma = gl.luma || {};\n  const {\n    luma\n  } = gl;\n\n  if (!luma.polyfilled) {\n    polyfillVertexArrayObject(gl);\n    initializeExtensions(gl);\n    installPolyfills(gl, WEBGL2_CONTEXT_POLYFILLS);\n    installOverrides(gl, {\n      target: luma,\n      target2: gl\n    });\n    luma.polyfilled = true;\n  }\n\n  return gl;\n}\nconst global_ = typeof global !== 'undefined' ? global : window;\nglobal_.polyfillContext = polyfillContext;\n\nfunction initializeExtensions(gl) {\n  gl.luma.extensions = {};\n  const EXTENSIONS = gl.getSupportedExtensions() || [];\n\n  for (const extension of EXTENSIONS) {\n    gl.luma[extension] = gl.getExtension(extension);\n  }\n}\n\nfunction installOverrides(gl, _ref) {\n  let {\n    target,\n    target2\n  } = _ref;\n  Object.keys(WEBGL2_CONTEXT_OVERRIDES).forEach(key => {\n    if (typeof WEBGL2_CONTEXT_OVERRIDES[key] === 'function') {\n      const originalFunc = gl[key] ? gl[key].bind(gl) : () => {};\n      const polyfill = WEBGL2_CONTEXT_OVERRIDES[key].bind(null, gl, originalFunc);\n      target[key] = polyfill;\n      target2[key] = polyfill;\n    }\n  });\n}\n\nfunction installPolyfills(gl, polyfills) {\n  for (const extension of Object.getOwnPropertyNames(polyfills)) {\n    if (extension !== 'overrides') {\n      polyfillExtension(gl, {\n        extension,\n        target: gl.luma,\n        target2: gl\n      });\n    }\n  }\n}\n\nfunction polyfillExtension(gl, _ref2) {\n  let {\n    extension,\n    target,\n    target2\n  } = _ref2;\n  const defaults = WEBGL2_CONTEXT_POLYFILLS[extension];\n  assert(defaults);\n  const {\n    meta = {}\n  } = defaults;\n  const {\n    suffix = ''\n  } = meta;\n  const ext = gl.getExtension(extension);\n\n  for (const key of Object.keys(defaults)) {\n    const extKey = `${key}${suffix}`;\n    let polyfill = null;\n\n    if (key === 'meta') {} else if (typeof gl[key] === 'function') {} else if (ext && typeof ext[extKey] === 'function') {\n      polyfill = function () {\n        return ext[extKey](...arguments);\n      };\n    } else if (typeof defaults[key] === 'function') {\n      polyfill = defaults[key].bind(target);\n    }\n\n    if (polyfill) {\n      target[key] = polyfill;\n      target2[key] = polyfill;\n    }\n  }\n}","map":{"version":3,"mappings":"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","names":["polyfillVertexArrayObject","assert","WEBGL2_CONTEXT_POLYFILLS","WEBGL2_CONTEXT_OVERRIDES","polyfillContext","gl","luma","polyfilled","initializeExtensions","installPolyfills","installOverrides","target","target2","global_","global","window","extensions","EXTENSIONS","getSupportedExtensions","extension","getExtension","Object","keys","forEach","key","originalFunc","bind","polyfill","polyfills","getOwnPropertyNames","polyfillExtension","defaults","meta","suffix","ext","extKey"],"sources":["../../../src/polyfill/polyfill-context.js"],"sourcesContent":["// WebGL1/WebGL2 extension polyfill support\n//\n// Provides a function that creates polyfills for WebGL2 functions based\n// on available extensions and installs them on a supplied target (could be\n// the WebGLContext or its prototype, or a separate object).\n//\n// This is intended to be a stand-alone file with minimal dependencies,\n// easy to reuse or repurpose in other projects.\n\n/** @typedef {import('./polyfill-context')} types */\n\nimport {polyfillVertexArrayObject} from './polyfill-vertex-array-object';\nimport {assert} from '../utils/assert';\n\nimport {WEBGL2_CONTEXT_POLYFILLS, WEBGL2_CONTEXT_OVERRIDES} from './polyfill-table';\n\n/** @type {types['polyfillContext']} */\nexport function polyfillContext(gl) {\n  // @ts-ignore\n  gl.luma = gl.luma || {};\n  // @ts-ignore\n  const {luma} = gl;\n\n  if (!luma.polyfilled) {\n    polyfillVertexArrayObject(gl);\n    initializeExtensions(gl);\n    installPolyfills(gl, WEBGL2_CONTEXT_POLYFILLS);\n    installOverrides(gl, {target: luma, target2: gl});\n    luma.polyfilled = true;\n  }\n\n  // TODO - only supporting a few members\n  /** @type {WebGL2RenderingContext} */\n  // @ts-ignore\n  return gl;\n}\n\n// TODO - is this still required?\nconst global_ = typeof global !== 'undefined' ? global : window;\n// @ts-ignore\nglobal_.polyfillContext = polyfillContext;\n\nfunction initializeExtensions(gl) {\n  gl.luma.extensions = {};\n  // `getSupportedExtensions` can return null when context is lost.\n  const EXTENSIONS = gl.getSupportedExtensions() || [];\n  for (const extension of EXTENSIONS) {\n    gl.luma[extension] = gl.getExtension(extension);\n  }\n}\n\n// Install simple overrides (mostly get* functions)\nfunction installOverrides(gl, {target, target2}) {\n  Object.keys(WEBGL2_CONTEXT_OVERRIDES).forEach(key => {\n    if (typeof WEBGL2_CONTEXT_OVERRIDES[key] === 'function') {\n      // install an override, if no implementation was detected\n      const originalFunc = gl[key] ? gl[key].bind(gl) : () => {};\n      const polyfill = WEBGL2_CONTEXT_OVERRIDES[key].bind(null, gl, originalFunc);\n      target[key] = polyfill;\n      target2[key] = polyfill;\n    }\n  });\n}\n\nfunction installPolyfills(gl, polyfills) {\n  for (const extension of Object.getOwnPropertyNames(polyfills)) {\n    if (extension !== 'overrides') {\n      polyfillExtension(gl, {extension, target: gl.luma, target2: gl});\n    }\n  }\n}\n\n// Polyfills a single WebGL extension into the `target` object\nfunction polyfillExtension(gl, {extension, target, target2}) {\n  const defaults = WEBGL2_CONTEXT_POLYFILLS[extension];\n  assert(defaults);\n\n  const {meta = {}} = defaults;\n  const {suffix = ''} = meta;\n\n  const ext = gl.getExtension(extension);\n\n  for (const key of Object.keys(defaults)) {\n    const extKey = `${key}${suffix}`;\n\n    let polyfill = null;\n    if (key === 'meta') {\n      // ignore\n    } else if (typeof gl[key] === 'function') {\n      // WebGL2 implementation is already\n    } else if (ext && typeof ext[extKey] === 'function') {\n      // pick extension implemenentation,if available\n      polyfill = (...args) => ext[extKey](...args);\n    } else if (typeof defaults[key] === 'function') {\n      // pick the mock implementation, if no implementation was detected\n      polyfill = defaults[key].bind(target);\n    }\n\n    if (polyfill) {\n      target[key] = polyfill;\n      target2[key] = polyfill;\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}