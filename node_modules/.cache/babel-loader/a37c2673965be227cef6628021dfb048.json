{"ast":null,"code":"import _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport { assert } from '../env-utils/assert';\nimport { getLoadableWorkerURL } from '../worker-utils/get-loadable-worker-url';\nimport { getTransferList } from '../worker-utils/get-transfer-list';\n\nconst NOOP = () => {};\n\nexport default class WorkerThread {\n  static isSupported() {\n    return typeof Worker !== 'undefined';\n  }\n\n  constructor(props) {\n    _defineProperty(this, \"name\", void 0);\n\n    _defineProperty(this, \"source\", void 0);\n\n    _defineProperty(this, \"url\", void 0);\n\n    _defineProperty(this, \"terminated\", false);\n\n    _defineProperty(this, \"worker\", void 0);\n\n    _defineProperty(this, \"onMessage\", void 0);\n\n    _defineProperty(this, \"onError\", void 0);\n\n    _defineProperty(this, \"_loadableURL\", '');\n\n    const {\n      name,\n      source,\n      url\n    } = props;\n    assert(source || url);\n    this.name = name;\n    this.source = source;\n    this.url = url;\n    this.onMessage = NOOP;\n\n    this.onError = error => console.log(error);\n\n    this.worker = this._createBrowserWorker();\n  }\n\n  destroy() {\n    this.onMessage = NOOP;\n    this.onError = NOOP;\n    this.worker.terminate();\n    this.terminated = true;\n  }\n\n  get isRunning() {\n    return Boolean(this.onMessage);\n  }\n\n  postMessage(data, transferList) {\n    transferList = transferList || getTransferList(data);\n    this.worker.postMessage(data, transferList);\n  }\n\n  _getErrorFromErrorEvent(event) {\n    let message = 'Failed to load ';\n    message += \"worker \".concat(this.name, \" from \").concat(this.url, \". \");\n\n    if (event.message) {\n      message += \"\".concat(event.message, \" in \");\n    }\n\n    if (event.lineno) {\n      message += \":\".concat(event.lineno, \":\").concat(event.colno);\n    }\n\n    return new Error(message);\n  }\n\n  _createBrowserWorker() {\n    this._loadableURL = getLoadableWorkerURL({\n      source: this.source,\n      url: this.url\n    });\n    const worker = new Worker(this._loadableURL, {\n      name: this.name\n    });\n\n    worker.onmessage = event => {\n      if (!event.data) {\n        this.onError(new Error('No data received'));\n      } else {\n        this.onMessage(event.data);\n      }\n    };\n\n    worker.onerror = error => {\n      this.onError(this._getErrorFromErrorEvent(error));\n      this.terminated = true;\n    };\n\n    worker.onmessageerror = event => console.error(event);\n\n    return worker;\n  }\n\n}","map":{"version":3,"mappings":";AAAA,SAAQA,MAAR,QAAqB,qBAArB;AACA,SAAQC,oBAAR,QAAmC,yCAAnC;AACA,SAAQC,eAAR,QAA8B,mCAA9B;;AAEA,MAAMC,IAAI,GAAG,MAAM,CAAnB;;AAWA,eAAe,MAAMC,YAAN,CAAmB;EAWd,OAAXC,WAAW,GAAY;IAC5B,OAAO,OAAOC,MAAP,KAAkB,WAAzB;EACD;;EAEDC,WAAW,CAACC,KAAD,EAA2B;IAAAC;;IAAAA;;IAAAA;;IAAAA,oCAXhB,KAWgB;;IAAAA;;IAAAA;;IAAAA;;IAAAA,sCANP,EAMO;;IACpC,MAAM;MAACC,IAAD;MAAOC,MAAP;MAAeC;IAAf,IAAsBJ,KAA5B;IACAR,MAAM,CAACW,MAAM,IAAIC,GAAX,CAANZ;IACA,KAAKU,IAAL,GAAYA,IAAZ;IACA,KAAKC,MAAL,GAAcA,MAAd;IACA,KAAKC,GAAL,GAAWA,GAAX;IACA,KAAKC,SAAL,GAAiBV,IAAjB;;IACA,KAAKW,OAAL,GAAgBC,KAAD,IAAWC,OAAO,CAACC,GAARD,CAAYD,KAAZC,CAA1B;;IAEA,KAAKE,MAAL,GAAc,KAAKC,oBAAL,EAAd;EACD;;EAMDC,OAAO,GAAS;IACd,KAAKP,SAAL,GAAiBV,IAAjB;IACA,KAAKW,OAAL,GAAeX,IAAf;IAEA,KAAKe,MAAL,CAAYG,SAAZ;IACA,KAAKC,UAAL,GAAkB,IAAlB;EACD;;EAEY,IAATC,SAAS,GAAG;IACd,OAAOC,OAAO,CAAC,KAAKX,SAAN,CAAd;EACD;;EAODY,WAAW,CAACC,IAAD,EAAYC,YAAZ,EAAwC;IACjDA,YAAY,GAAGA,YAAY,IAAIzB,eAAe,CAACwB,IAAD,CAA9CC;IAEA,KAAKT,MAAL,CAAYO,WAAZ,CAAwBC,IAAxB,EAA8BC,YAA9B;EACD;;EAQDC,uBAAuB,CAACC,KAAD,EAA2B;IAIhD,IAAIC,OAAO,GAAG,iBAAd;IACAA,OAAO,qBAAc,KAAKpB,IAAnB,mBAAgC,KAAKE,GAArC,OAAPkB;;IACA,IAAID,KAAK,CAACC,OAAV,EAAmB;MACjBA,OAAO,cAAOD,KAAK,CAACC,OAAb,SAAPA;IACD;;IAGD,IAAID,KAAK,CAACE,MAAV,EAAkB;MAChBD,OAAO,eAAQD,KAAK,CAACE,MAAd,cAAwBF,KAAK,CAACG,KAA9B,CAAPF;IACD;;IACD,OAAO,IAAIG,KAAJ,CAAUH,OAAV,CAAP;EACD;;EAKDX,oBAAoB,GAAG;IACrB,KAAKe,YAAL,GAAoBjC,oBAAoB,CAAC;MAACU,MAAM,EAAE,KAAKA,MAAd;MAAsBC,GAAG,EAAE,KAAKA;IAAhC,CAAD,CAAxC;IACA,MAAMM,MAAM,GAAG,IAAIZ,MAAJ,CAAW,KAAK4B,YAAhB,EAA8B;MAACxB,IAAI,EAAE,KAAKA;IAAZ,CAA9B,CAAf;;IAEAQ,MAAM,CAACiB,SAAPjB,GAAoBW,KAAD,IAAW;MAC5B,IAAI,CAACA,KAAK,CAACH,IAAX,EAAiB;QACf,KAAKZ,OAAL,CAAa,IAAImB,KAAJ,CAAU,kBAAV,CAAb;MADF,OAEO;QACL,KAAKpB,SAAL,CAAegB,KAAK,CAACH,IAArB;MACD;IALH;;IAQAR,MAAM,CAACkB,OAAPlB,GAAkBH,KAAD,IAA6B;MAC5C,KAAKD,OAAL,CAAa,KAAKc,uBAAL,CAA6Bb,KAA7B,CAAb;MACA,KAAKO,UAAL,GAAkB,IAAlB;IAFF;;IAKAJ,MAAM,CAACmB,cAAPnB,GAAyBW,KAAD,IAAWb,OAAO,CAACD,KAARC,CAAca,KAAdb,CAAnCE;;IAEA,OAAOA,MAAP;EACD;;AApG+B","names":["assert","getLoadableWorkerURL","getTransferList","NOOP","WorkerThread","isSupported","Worker","constructor","props","_defineProperty","name","source","url","onMessage","onError","error","console","log","worker","_createBrowserWorker","destroy","terminate","terminated","isRunning","Boolean","postMessage","data","transferList","_getErrorFromErrorEvent","event","message","lineno","colno","Error","_loadableURL","onmessage","onerror","onmessageerror"],"sources":["../../../../src/lib/worker-farm/worker-thread.ts"],"sourcesContent":["import {assert} from '../env-utils/assert';\nimport {getLoadableWorkerURL} from '../worker-utils/get-loadable-worker-url';\nimport {getTransferList} from '../worker-utils/get-transfer-list';\n\nconst NOOP = () => {};\n\nexport type WorkerThreadProps = {\n  name: string;\n  source?: string;\n  url?: string;\n};\n\n/**\n * Represents one worker thread\n */\nexport default class WorkerThread {\n  readonly name: string;\n  readonly source: string | undefined;\n  readonly url: string | undefined;\n  terminated: boolean = false;\n  worker: Worker;\n  onMessage: (message: any) => void;\n  onError: (error: Error) => void;\n\n  private _loadableURL: string = '';\n\n  static isSupported(): boolean {\n    return typeof Worker !== 'undefined';\n  }\n\n  constructor(props: WorkerThreadProps) {\n    const {name, source, url} = props;\n    assert(source || url); // Either source or url must be defined\n    this.name = name;\n    this.source = source;\n    this.url = url;\n    this.onMessage = NOOP;\n    this.onError = (error) => console.log(error); // eslint-disable-line\n\n    this.worker = this._createBrowserWorker();\n  }\n\n  /**\n   * Terminate this worker thread\n   * @note Can free up significant memory\n   */\n  destroy(): void {\n    this.onMessage = NOOP;\n    this.onError = NOOP;\n    // @ts-ignore\n    this.worker.terminate();\n    this.terminated = true;\n  }\n\n  get isRunning() {\n    return Boolean(this.onMessage);\n  }\n\n  /**\n   * Send a message to this worker thread\n   * @param data any data structure, ideally consisting mostly of transferrable objects\n   * @param transferList If not supplied, calculated automatically by traversing data\n   */\n  postMessage(data: any, transferList?: any[]): void {\n    transferList = transferList || getTransferList(data);\n    // @ts-ignore\n    this.worker.postMessage(data, transferList);\n  }\n\n  // PRIVATE\n\n  /**\n   * Generate a standard Error from an ErrorEvent\n   * @param {ErrorEvent} event\n   */\n  _getErrorFromErrorEvent(event: ErrorEvent): Error {\n    // Note Error object does not have the expected fields if loading failed completely\n    // https://developer.mozilla.org/en-US/docs/Web/API/Worker#Event_handlers\n    // https://developer.mozilla.org/en-US/docs/Web/API/ErrorEvent\n    let message = 'Failed to load ';\n    message += `worker ${this.name} from ${this.url}. `;\n    if (event.message) {\n      message += `${event.message} in `;\n    }\n    // const hasFilename = event.filename && !event.filename.startsWith('blob:');\n    // message += hasFilename ? event.filename : this.source.slice(0, 100);\n    if (event.lineno) {\n      message += `:${event.lineno}:${event.colno}`;\n    }\n    return new Error(message);\n  }\n\n  /**\n   * Creates a worker thread on the browser\n   */\n  _createBrowserWorker() {\n    this._loadableURL = getLoadableWorkerURL({source: this.source, url: this.url});\n    const worker = new Worker(this._loadableURL, {name: this.name});\n\n    worker.onmessage = (event) => {\n      if (!event.data) {\n        this.onError(new Error('No data received'));\n      } else {\n        this.onMessage(event.data);\n      }\n    };\n    // This callback represents an uncaught exception in the worker thread\n    worker.onerror = (error: ErrorEvent): void => {\n      this.onError(this._getErrorFromErrorEvent(error));\n      this.terminated = true;\n    };\n    // TODO - not clear when this would be called, for now just log in case it happens\n    worker.onmessageerror = (event) => console.error(event); // eslint-disable-line\n\n    return worker;\n  }\n}\n"]},"metadata":{},"sourceType":"module"}