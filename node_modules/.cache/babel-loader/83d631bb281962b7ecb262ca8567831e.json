{"ast":null,"code":"import _objectSpread from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";\nimport _defineProperty2 from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/defineProperty.js\";\nimport _classCallCheck from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/classCallCheck.js\";\nimport _createClass from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/createClass.js\";\nimport _assertThisInitialized from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/assertThisInitialized.js\";\nimport _get from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/get.js\";\nimport _getPrototypeOf from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/getPrototypeOf.js\";\nimport _inherits from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/inherits.js\";\nimport _createSuper from \"/Users/tomasehrenfeld/projs/se-team/tomas/react-apps/custom_filter/node_modules/@babel/runtime/helpers/esm/createSuper.js\";\nimport _defineProperty from \"@babel/runtime/helpers/esm/defineProperty\";\nimport { default as LayersPass } from './layers-pass';\nimport { Framebuffer, Texture2D, Renderbuffer, withParameters, cssToDeviceRatio } from '@luma.gl/core';\n\nvar ShadowPass = /*#__PURE__*/function (_LayersPass) {\n  _inherits(ShadowPass, _LayersPass);\n\n  var _super = _createSuper(ShadowPass);\n\n  function ShadowPass(gl, props) {\n    var _parameters, _attachments;\n\n    var _this;\n\n    _classCallCheck(this, ShadowPass);\n\n    _this = _super.call(this, gl, props);\n\n    _defineProperty(_assertThisInitialized(_this), \"shadowMap\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"depthBuffer\", void 0);\n\n    _defineProperty(_assertThisInitialized(_this), \"fbo\", void 0);\n\n    _this.shadowMap = new Texture2D(gl, {\n      width: 1,\n      height: 1,\n      parameters: (_parameters = {}, _defineProperty2(_parameters, 10241, 9729), _defineProperty2(_parameters, 10240, 9729), _defineProperty2(_parameters, 10242, 33071), _defineProperty2(_parameters, 10243, 33071), _parameters)\n    });\n    _this.depthBuffer = new Renderbuffer(gl, {\n      format: 33189,\n      width: 1,\n      height: 1\n    });\n    _this.fbo = new Framebuffer(gl, {\n      id: 'shadowmap',\n      width: 1,\n      height: 1,\n      attachments: (_attachments = {}, _defineProperty2(_attachments, 36064, _this.shadowMap), _defineProperty2(_attachments, 36096, _this.depthBuffer), _attachments)\n    });\n    return _this;\n  }\n\n  _createClass(ShadowPass, [{\n    key: \"render\",\n    value: function render(params) {\n      var _this2 = this;\n\n      var target = this.fbo;\n      withParameters(this.gl, {\n        depthRange: [0, 1],\n        depthTest: true,\n        blend: false,\n        clearColor: [1, 1, 1, 1]\n      }, function () {\n        var viewport = params.viewports[0];\n        var pixelRatio = cssToDeviceRatio(_this2.gl);\n        var width = viewport.width * pixelRatio;\n        var height = viewport.height * pixelRatio;\n\n        if (width !== target.width || height !== target.height) {\n          target.resize({\n            width: width,\n            height: height\n          });\n        }\n\n        _get(_getPrototypeOf(ShadowPass.prototype), \"render\", _this2).call(_this2, _objectSpread(_objectSpread({}, params), {}, {\n          target: target,\n          pass: 'shadow'\n        }));\n      });\n    }\n  }, {\n    key: \"shouldDrawLayer\",\n    value: function shouldDrawLayer(layer) {\n      return layer.props.shadowEnabled !== false;\n    }\n  }, {\n    key: \"getModuleParameters\",\n    value: function getModuleParameters() {\n      return {\n        drawToShadowMap: true\n      };\n    }\n  }, {\n    key: \"delete\",\n    value: function _delete() {\n      if (this.fbo) {\n        this.fbo.delete();\n        this.fbo = null;\n      }\n\n      if (this.shadowMap) {\n        this.shadowMap.delete();\n        this.shadowMap = null;\n      }\n\n      if (this.depthBuffer) {\n        this.depthBuffer.delete();\n        this.depthBuffer = null;\n      }\n    }\n  }]);\n\n  return ShadowPass;\n}(LayersPass);\n\nexport { ShadowPass as default };","map":{"version":3,"mappings":";;;;;;;;;;AAAA,SAAQA,OAAO,IAAIC,UAAnB,QAAoC,eAApC;AACA,SACEC,WADF,EAEEC,SAFF,EAGEC,YAHF,EAIEC,cAJF,EAKEC,gBALF,QAMO,eANP;;IAQqBC,U;;;;;EAKnBC,oBAAYC,EAAZD,EAAgBE,KAAhBF,EAAuB;IAAA;;IAAA;;IAAA;;IACrB,0BAAMC,EAAN,EAAUC,KAAV;;IADqBC;;IAAAA;;IAAAA;;IAIrB,MAAKC,SAAL,GAAiB,IAAIT,SAAJ,CAAcM,EAAd,EAAkB;MACjCI,KAAK,EAAE,CAD0B;MAEjCC,MAAM,EAAE,CAFyB;MAGjCC,UAAU,mDACR,KADQ,EACR,IADQ,iCAER,KAFQ,EAER,IAFQ,iCAGR,KAHQ,EAGR,KAHQ,iCAIR,KAJQ,EAIR,KAJQ;IAHuB,CAAlB,CAAjB;IAWA,MAAKC,WAAL,GAAmB,IAAIZ,YAAJ,CAAiBK,EAAjB,EAAqB;MACtCQ,MAAM,OADgC;MAEtCJ,KAAK,EAAE,CAF+B;MAGtCC,MAAM,EAAE;IAH8B,CAArB,CAAnB;IAMA,MAAKI,GAAL,GAAW,IAAIhB,WAAJ,CAAgBO,EAAhB,EAAoB;MAC7BU,EAAE,EAAE,WADyB;MAE7BN,KAAK,EAAE,CAFsB;MAG7BC,MAAM,EAAE,CAHqB;MAI7BM,WAAW,qDACT,KADS,EACe,MAAKR,SADpB,kCAGT,KAHS,EAGc,MAAKI,WAHnB;IAJkB,CAApB,CAAX;IArBqB;EA+BtB;;;;WAEDK,gBAAOC,MAAPD,EAAe;MAAA;;MACb,IAAME,MAAM,GAAG,KAAKL,GAApB;MAEAb,cAAc,CACZ,KAAKI,EADO,EAEZ;QACEe,UAAU,EAAE,CAAC,CAAD,EAAI,CAAJ,CADd;QAEEC,SAAS,EAAE,IAFb;QAGEC,KAAK,EAAE,KAHT;QAIEC,UAAU,EAAE,CAAC,CAAD,EAAI,CAAJ,EAAO,CAAP,EAAU,CAAV;MAJd,CAFY,EAQZ,YAAM;QACJ,IAAMC,QAAQ,GAAGN,MAAM,CAACO,SAAPP,CAAiB,CAAjBA,CAAjB;QACA,IAAMQ,UAAU,GAAGxB,gBAAgB,CAAC,OAAKG,EAAN,CAAnC;QACA,IAAMI,KAAK,GAAGe,QAAQ,CAACf,KAATe,GAAiBE,UAA/B;QACA,IAAMhB,MAAM,GAAGc,QAAQ,CAACd,MAATc,GAAkBE,UAAjC;;QACA,IAAIjB,KAAK,KAAKU,MAAM,CAACV,KAAjBA,IAA0BC,MAAM,KAAKS,MAAM,CAACT,MAAhD,EAAwD;UACtDS,MAAM,CAACQ,MAAPR,CAAc;YAACV,KAAD,EAACA,KAAD;YAAQC;UAAR,CAAdS;QACD;;QAED,2GAAiBD,MAAjB;UAAyBC,MAAZ,EAAYA,MAAzB;UAAiCS,IAAI,EAAE;QAAvC;MAjBU,EAAd3B;IAoBD;;;WAED4B,yBAAgBC,KAAhBD,EAAuB;MACrB,OAAOC,KAAK,CAACxB,KAANwB,CAAYC,aAAZD,KAA8B,KAArC;IACD;;;WAEDE,+BAAsB;MACpB,OAAO;QACLC,eAAe,EAAE;MADZ,CAAP;IAGD;;;WAEDC,mBAAS;MACP,IAAI,KAAKpB,GAAT,EAAc;QACZ,KAAKA,GAAL,CAASoB,MAAT;QACA,KAAKpB,GAAL,GAAW,IAAX;MACD;;MAED,IAAI,KAAKN,SAAT,EAAoB;QAClB,KAAKA,SAAL,CAAe0B,MAAf;QACA,KAAK1B,SAAL,GAAiB,IAAjB;MACD;;MAED,IAAI,KAAKI,WAAT,EAAsB;QACpB,KAAKA,WAAL,CAAiBsB,MAAjB;QACA,KAAKtB,WAAL,GAAmB,IAAnB;MACD;IACF;;;;EAxFqCf,U;;SAAnBM,U","names":["default","LayersPass","Framebuffer","Texture2D","Renderbuffer","withParameters","cssToDeviceRatio","ShadowPass","constructor","gl","props","_defineProperty","shadowMap","width","height","parameters","depthBuffer","format","fbo","id","attachments","render","params","target","depthRange","depthTest","blend","clearColor","viewport","viewports","pixelRatio","resize","pass","shouldDrawLayer","layer","shadowEnabled","getModuleParameters","drawToShadowMap","delete"],"sources":["../../../src/passes/shadow-pass.ts"],"sourcesContent":["import {default as LayersPass} from './layers-pass';\nimport {\n  Framebuffer,\n  Texture2D,\n  Renderbuffer,\n  withParameters,\n  cssToDeviceRatio\n} from '@luma.gl/core';\n\nexport default class ShadowPass extends LayersPass {\n  shadowMap: Texture2D;\n  depthBuffer: Renderbuffer;\n  fbo: Framebuffer;\n\n  constructor(gl, props) {\n    super(gl, props);\n\n    // The shadowMap texture\n    this.shadowMap = new Texture2D(gl, {\n      width: 1,\n      height: 1,\n      parameters: {\n        [gl.TEXTURE_MIN_FILTER]: gl.LINEAR,\n        [gl.TEXTURE_MAG_FILTER]: gl.LINEAR,\n        [gl.TEXTURE_WRAP_S]: gl.CLAMP_TO_EDGE,\n        [gl.TEXTURE_WRAP_T]: gl.CLAMP_TO_EDGE\n      }\n    });\n\n    this.depthBuffer = new Renderbuffer(gl, {\n      format: gl.DEPTH_COMPONENT16,\n      width: 1,\n      height: 1\n    });\n\n    this.fbo = new Framebuffer(gl, {\n      id: 'shadowmap',\n      width: 1,\n      height: 1,\n      attachments: {\n        [gl.COLOR_ATTACHMENT0]: this.shadowMap,\n        // Depth attachment has to be specified for depth test to work\n        [gl.DEPTH_ATTACHMENT]: this.depthBuffer\n      }\n    });\n  }\n\n  render(params) {\n    const target = this.fbo;\n\n    withParameters(\n      this.gl,\n      {\n        depthRange: [0, 1],\n        depthTest: true,\n        blend: false,\n        clearColor: [1, 1, 1, 1]\n      },\n      () => {\n        const viewport = params.viewports[0];\n        const pixelRatio = cssToDeviceRatio(this.gl);\n        const width = viewport.width * pixelRatio;\n        const height = viewport.height * pixelRatio;\n        if (width !== target.width || height !== target.height) {\n          target.resize({width, height});\n        }\n\n        super.render({...params, target, pass: 'shadow'});\n      }\n    );\n  }\n\n  shouldDrawLayer(layer) {\n    return layer.props.shadowEnabled !== false;\n  }\n\n  getModuleParameters() {\n    return {\n      drawToShadowMap: true\n    };\n  }\n\n  delete() {\n    if (this.fbo) {\n      this.fbo.delete();\n      this.fbo = null;\n    }\n\n    if (this.shadowMap) {\n      this.shadowMap.delete();\n      this.shadowMap = null;\n    }\n\n    if (this.depthBuffer) {\n      this.depthBuffer.delete();\n      this.depthBuffer = null;\n    }\n  }\n}\n"]},"metadata":{},"sourceType":"module"}