{"ast":null,"code":"export default class Delatin {\n  constructor(data, width) {\n    let height = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : width;\n    this.data = data;\n    this.width = width;\n    this.height = height;\n    this.coords = [];\n    this.triangles = [];\n    this._halfedges = [];\n    this._candidates = [];\n    this._queueIndices = [];\n    this._queue = [];\n    this._errors = [];\n    this._rms = [];\n    this._pending = [];\n    this._pendingLen = 0;\n    this._rmsSum = 0;\n    const x1 = width - 1;\n    const y1 = height - 1;\n\n    const p0 = this._addPoint(0, 0);\n\n    const p1 = this._addPoint(x1, 0);\n\n    const p2 = this._addPoint(0, y1);\n\n    const p3 = this._addPoint(x1, y1);\n\n    const t0 = this._addTriangle(p3, p0, p2, -1, -1, -1);\n\n    this._addTriangle(p0, p3, p1, t0, -1, -1);\n\n    this._flush();\n  }\n\n  run() {\n    let maxError = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : 1;\n\n    while (this.getMaxError() > maxError) {\n      this.refine();\n    }\n  }\n\n  refine() {\n    this._step();\n\n    this._flush();\n  }\n\n  getMaxError() {\n    return this._errors[0];\n  }\n\n  getRMSD() {\n    return this._rmsSum > 0 ? Math.sqrt(this._rmsSum / (this.width * this.height)) : 0;\n  }\n\n  heightAt(x, y) {\n    return this.data[this.width * y + x];\n  }\n\n  _flush() {\n    const coords = this.coords;\n\n    for (let i = 0; i < this._pendingLen; i++) {\n      const t = this._pending[i];\n      const a = 2 * this.triangles[t * 3 + 0];\n      const b = 2 * this.triangles[t * 3 + 1];\n      const c = 2 * this.triangles[t * 3 + 2];\n\n      this._findCandidate(coords[a], coords[a + 1], coords[b], coords[b + 1], coords[c], coords[c + 1], t);\n    }\n\n    this._pendingLen = 0;\n  }\n\n  _findCandidate(p0x, p0y, p1x, p1y, p2x, p2y, t) {\n    const minX = Math.min(p0x, p1x, p2x);\n    const minY = Math.min(p0y, p1y, p2y);\n    const maxX = Math.max(p0x, p1x, p2x);\n    const maxY = Math.max(p0y, p1y, p2y);\n    let w00 = orient(p1x, p1y, p2x, p2y, minX, minY);\n    let w01 = orient(p2x, p2y, p0x, p0y, minX, minY);\n    let w02 = orient(p0x, p0y, p1x, p1y, minX, minY);\n    const a01 = p1y - p0y;\n    const b01 = p0x - p1x;\n    const a12 = p2y - p1y;\n    const b12 = p1x - p2x;\n    const a20 = p0y - p2y;\n    const b20 = p2x - p0x;\n    const a = orient(p0x, p0y, p1x, p1y, p2x, p2y);\n    const z0 = this.heightAt(p0x, p0y) / a;\n    const z1 = this.heightAt(p1x, p1y) / a;\n    const z2 = this.heightAt(p2x, p2y) / a;\n    let maxError = 0;\n    let mx = 0;\n    let my = 0;\n    let rms = 0;\n\n    for (let y = minY; y <= maxY; y++) {\n      let dx = 0;\n\n      if (w00 < 0 && a12 !== 0) {\n        dx = Math.max(dx, Math.floor(-w00 / a12));\n      }\n\n      if (w01 < 0 && a20 !== 0) {\n        dx = Math.max(dx, Math.floor(-w01 / a20));\n      }\n\n      if (w02 < 0 && a01 !== 0) {\n        dx = Math.max(dx, Math.floor(-w02 / a01));\n      }\n\n      let w0 = w00 + a12 * dx;\n      let w1 = w01 + a20 * dx;\n      let w2 = w02 + a01 * dx;\n      let wasInside = false;\n\n      for (let x = minX + dx; x <= maxX; x++) {\n        if (w0 >= 0 && w1 >= 0 && w2 >= 0) {\n          wasInside = true;\n          const z = z0 * w0 + z1 * w1 + z2 * w2;\n          const dz = Math.abs(z - this.heightAt(x, y));\n          rms += dz * dz;\n\n          if (dz > maxError) {\n            maxError = dz;\n            mx = x;\n            my = y;\n          }\n        } else if (wasInside) {\n          break;\n        }\n\n        w0 += a12;\n        w1 += a20;\n        w2 += a01;\n      }\n\n      w00 += b12;\n      w01 += b20;\n      w02 += b01;\n    }\n\n    if (mx === p0x && my === p0y || mx === p1x && my === p1y || mx === p2x && my === p2y) {\n      maxError = 0;\n    }\n\n    this._candidates[2 * t] = mx;\n    this._candidates[2 * t + 1] = my;\n    this._rms[t] = rms;\n\n    this._queuePush(t, maxError, rms);\n  }\n\n  _step() {\n    const t = this._queuePop();\n\n    const e0 = t * 3 + 0;\n    const e1 = t * 3 + 1;\n    const e2 = t * 3 + 2;\n    const p0 = this.triangles[e0];\n    const p1 = this.triangles[e1];\n    const p2 = this.triangles[e2];\n    const ax = this.coords[2 * p0];\n    const ay = this.coords[2 * p0 + 1];\n    const bx = this.coords[2 * p1];\n    const by = this.coords[2 * p1 + 1];\n    const cx = this.coords[2 * p2];\n    const cy = this.coords[2 * p2 + 1];\n    const px = this._candidates[2 * t];\n    const py = this._candidates[2 * t + 1];\n\n    const pn = this._addPoint(px, py);\n\n    if (orient(ax, ay, bx, by, px, py) === 0) {\n      this._handleCollinear(pn, e0);\n    } else if (orient(bx, by, cx, cy, px, py) === 0) {\n      this._handleCollinear(pn, e1);\n    } else if (orient(cx, cy, ax, ay, px, py) === 0) {\n      this._handleCollinear(pn, e2);\n    } else {\n      const h0 = this._halfedges[e0];\n      const h1 = this._halfedges[e1];\n      const h2 = this._halfedges[e2];\n\n      const t0 = this._addTriangle(p0, p1, pn, h0, -1, -1, e0);\n\n      const t1 = this._addTriangle(p1, p2, pn, h1, -1, t0 + 1);\n\n      const t2 = this._addTriangle(p2, p0, pn, h2, t0 + 2, t1 + 1);\n\n      this._legalize(t0);\n\n      this._legalize(t1);\n\n      this._legalize(t2);\n    }\n  }\n\n  _addPoint(x, y) {\n    const i = this.coords.length >> 1;\n    this.coords.push(x, y);\n    return i;\n  }\n\n  _addTriangle(a, b, c, ab, bc, ca) {\n    let e = arguments.length > 6 && arguments[6] !== undefined ? arguments[6] : this.triangles.length;\n    const t = e / 3;\n    this.triangles[e + 0] = a;\n    this.triangles[e + 1] = b;\n    this.triangles[e + 2] = c;\n    this._halfedges[e + 0] = ab;\n    this._halfedges[e + 1] = bc;\n    this._halfedges[e + 2] = ca;\n\n    if (ab >= 0) {\n      this._halfedges[ab] = e + 0;\n    }\n\n    if (bc >= 0) {\n      this._halfedges[bc] = e + 1;\n    }\n\n    if (ca >= 0) {\n      this._halfedges[ca] = e + 2;\n    }\n\n    this._candidates[2 * t + 0] = 0;\n    this._candidates[2 * t + 1] = 0;\n    this._queueIndices[t] = -1;\n    this._rms[t] = 0;\n    this._pending[this._pendingLen++] = t;\n    return e;\n  }\n\n  _legalize(a) {\n    const b = this._halfedges[a];\n\n    if (b < 0) {\n      return;\n    }\n\n    const a0 = a - a % 3;\n    const b0 = b - b % 3;\n    const al = a0 + (a + 1) % 3;\n    const ar = a0 + (a + 2) % 3;\n    const bl = b0 + (b + 2) % 3;\n    const br = b0 + (b + 1) % 3;\n    const p0 = this.triangles[ar];\n    const pr = this.triangles[a];\n    const pl = this.triangles[al];\n    const p1 = this.triangles[bl];\n    const coords = this.coords;\n\n    if (!inCircle(coords[2 * p0], coords[2 * p0 + 1], coords[2 * pr], coords[2 * pr + 1], coords[2 * pl], coords[2 * pl + 1], coords[2 * p1], coords[2 * p1 + 1])) {\n      return;\n    }\n\n    const hal = this._halfedges[al];\n    const har = this._halfedges[ar];\n    const hbl = this._halfedges[bl];\n    const hbr = this._halfedges[br];\n\n    this._queueRemove(a0 / 3);\n\n    this._queueRemove(b0 / 3);\n\n    const t0 = this._addTriangle(p0, p1, pl, -1, hbl, hal, a0);\n\n    const t1 = this._addTriangle(p1, p0, pr, t0, har, hbr, b0);\n\n    this._legalize(t0 + 1);\n\n    this._legalize(t1 + 2);\n  }\n\n  _handleCollinear(pn, a) {\n    const a0 = a - a % 3;\n    const al = a0 + (a + 1) % 3;\n    const ar = a0 + (a + 2) % 3;\n    const p0 = this.triangles[ar];\n    const pr = this.triangles[a];\n    const pl = this.triangles[al];\n    const hal = this._halfedges[al];\n    const har = this._halfedges[ar];\n    const b = this._halfedges[a];\n\n    if (b < 0) {\n      const t0 = this._addTriangle(pn, p0, pr, -1, har, -1, a0);\n\n      const t1 = this._addTriangle(p0, pn, pl, t0, -1, hal);\n\n      this._legalize(t0 + 1);\n\n      this._legalize(t1 + 2);\n\n      return;\n    }\n\n    const b0 = b - b % 3;\n    const bl = b0 + (b + 2) % 3;\n    const br = b0 + (b + 1) % 3;\n    const p1 = this.triangles[bl];\n    const hbl = this._halfedges[bl];\n    const hbr = this._halfedges[br];\n\n    this._queueRemove(b0 / 3);\n\n    const t0 = this._addTriangle(p0, pr, pn, har, -1, -1, a0);\n\n    const t1 = this._addTriangle(pr, p1, pn, hbr, -1, t0 + 1, b0);\n\n    const t2 = this._addTriangle(p1, pl, pn, hbl, -1, t1 + 1);\n\n    const t3 = this._addTriangle(pl, p0, pn, hal, t0 + 2, t2 + 1);\n\n    this._legalize(t0);\n\n    this._legalize(t1);\n\n    this._legalize(t2);\n\n    this._legalize(t3);\n  }\n\n  _queuePush(t, error, rms) {\n    const i = this._queue.length;\n    this._queueIndices[t] = i;\n\n    this._queue.push(t);\n\n    this._errors.push(error);\n\n    this._rmsSum += rms;\n\n    this._queueUp(i);\n  }\n\n  _queuePop() {\n    const n = this._queue.length - 1;\n\n    this._queueSwap(0, n);\n\n    this._queueDown(0, n);\n\n    return this._queuePopBack();\n  }\n\n  _queuePopBack() {\n    const t = this._queue.pop();\n\n    this._errors.pop();\n\n    this._rmsSum -= this._rms[t];\n    this._queueIndices[t] = -1;\n    return t;\n  }\n\n  _queueRemove(t) {\n    const i = this._queueIndices[t];\n\n    if (i < 0) {\n      const it = this._pending.indexOf(t);\n\n      if (it !== -1) {\n        this._pending[it] = this._pending[--this._pendingLen];\n      } else {\n        throw new Error('Broken triangulation (something went wrong).');\n      }\n\n      return;\n    }\n\n    const n = this._queue.length - 1;\n\n    if (n !== i) {\n      this._queueSwap(i, n);\n\n      if (!this._queueDown(i, n)) {\n        this._queueUp(i);\n      }\n    }\n\n    this._queuePopBack();\n  }\n\n  _queueLess(i, j) {\n    return this._errors[i] > this._errors[j];\n  }\n\n  _queueSwap(i, j) {\n    const pi = this._queue[i];\n    const pj = this._queue[j];\n    this._queue[i] = pj;\n    this._queue[j] = pi;\n    this._queueIndices[pi] = j;\n    this._queueIndices[pj] = i;\n    const e = this._errors[i];\n    this._errors[i] = this._errors[j];\n    this._errors[j] = e;\n  }\n\n  _queueUp(j0) {\n    let j = j0;\n\n    while (true) {\n      const i = j - 1 >> 1;\n\n      if (i === j || !this._queueLess(j, i)) {\n        break;\n      }\n\n      this._queueSwap(i, j);\n\n      j = i;\n    }\n  }\n\n  _queueDown(i0, n) {\n    let i = i0;\n\n    while (true) {\n      const j1 = 2 * i + 1;\n\n      if (j1 >= n || j1 < 0) {\n        break;\n      }\n\n      const j2 = j1 + 1;\n      let j = j1;\n\n      if (j2 < n && this._queueLess(j2, j1)) {\n        j = j2;\n      }\n\n      if (!this._queueLess(j, i)) {\n        break;\n      }\n\n      this._queueSwap(i, j);\n\n      i = j;\n    }\n\n    return i > i0;\n  }\n\n}\n\nfunction orient(ax, ay, bx, by, cx, cy) {\n  return (bx - cx) * (ay - cy) - (by - cy) * (ax - cx);\n}\n\nfunction inCircle(ax, ay, bx, by, cx, cy, px, py) {\n  const dx = ax - px;\n  const dy = ay - py;\n  const ex = bx - px;\n  const ey = by - py;\n  const fx = cx - px;\n  const fy = cy - py;\n  const ap = dx * dx + dy * dy;\n  const bp = ex * ex + ey * ey;\n  const cp = fx * fx + fy * fy;\n  return dx * (ey * cp - bp * fy) - dy * (ex * cp - bp * fx) + ap * (ex * fy - ey * fx) < 0;\n}","map":{"version":3,"mappings":"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","names":["Delatin","constructor","data","width","height","coords","triangles","_halfedges","_candidates","_queueIndices","_queue","_errors","_rms","_pending","_pendingLen","_rmsSum","x1","y1","p0","_addPoint","p1","p2","p3","t0","_addTriangle","_flush","run","maxError","getMaxError","refine","_step","getRMSD","Math","sqrt","heightAt","x","y","i","t","a","b","c","_findCandidate","p0x","p0y","p1x","p1y","p2x","p2y","minX","min","minY","maxX","max","maxY","w00","orient","w01","w02","a01","b01","a12","b12","a20","b20","z0","z1","z2","mx","my","rms","dx","floor","w0","w1","w2","wasInside","z","dz","abs","_queuePush","_queuePop","e0","e1","e2","ax","ay","bx","by","cx","cy","px","py","pn","_handleCollinear","h0","h1","h2","t1","t2","_legalize","length","push","ab","bc","ca","e","a0","b0","al","ar","bl","br","pr","pl","inCircle","hal","har","hbl","hbr","_queueRemove","t3","error","_queueUp","n","_queueSwap","_queueDown","_queuePopBack","pop","it","indexOf","Error","_queueLess","j","pi","pj","j0","i0","j1","j2","dy","ex","ey","fx","fy","ap","bp","cp"],"sources":["../../../../src/lib/delatin/index.ts"],"sourcesContent":["// ISC License\n\n// Copyright(c) 2019, Michael Fogleman, Vladimir Agafonkin\n\n// Permission to use, copy, modify, and / or distribute this software for any purpose\n// with or without fee is hereby granted, provided that the above copyright notice\n// and this permission notice appear in all copies.\n\n// THE SOFTWARE IS PROVIDED \"AS IS\" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH\n// REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY AND\n// FITNESS.IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,\n//   INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM LOSS\n// OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR OTHER\n// TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR PERFORMANCE OF\n// THIS SOFTWARE.\n\n// @ts-nocheck\n\n/* eslint-disable complexity, max-params, max-statements, max-depth, no-constant-condition */\nexport default class Delatin {\n  constructor(data, width, height = width) {\n    this.data = data; // height data\n    this.width = width;\n    this.height = height;\n\n    this.coords = []; // vertex coordinates (x, y)\n    this.triangles = []; // mesh triangle indices\n\n    // additional triangle data\n    this._halfedges = [];\n    this._candidates = [];\n    this._queueIndices = [];\n\n    this._queue = []; // queue of added triangles\n    this._errors = [];\n    this._rms = [];\n    this._pending = []; // triangles pending addition to queue\n    this._pendingLen = 0;\n\n    this._rmsSum = 0;\n\n    const x1 = width - 1;\n    const y1 = height - 1;\n    const p0 = this._addPoint(0, 0);\n    const p1 = this._addPoint(x1, 0);\n    const p2 = this._addPoint(0, y1);\n    const p3 = this._addPoint(x1, y1);\n\n    // add initial two triangles\n    const t0 = this._addTriangle(p3, p0, p2, -1, -1, -1);\n    this._addTriangle(p0, p3, p1, t0, -1, -1);\n    this._flush();\n  }\n\n  // refine the mesh until its maximum error gets below the given one\n  run(maxError = 1) {\n    while (this.getMaxError() > maxError) {\n      this.refine();\n    }\n  }\n\n  // refine the mesh with a single point\n  refine() {\n    this._step();\n    this._flush();\n  }\n\n  // max error of the current mesh\n  getMaxError() {\n    return this._errors[0];\n  }\n\n  // root-mean-square deviation of the current mesh\n  getRMSD() {\n    return this._rmsSum > 0 ? Math.sqrt(this._rmsSum / (this.width * this.height)) : 0;\n  }\n\n  // height value at a given position\n  heightAt(x, y) {\n    return this.data[this.width * y + x];\n  }\n\n  // rasterize and queue all triangles that got added or updated in _step\n  _flush() {\n    const coords = this.coords;\n    for (let i = 0; i < this._pendingLen; i++) {\n      const t = this._pending[i];\n      // rasterize triangle to find maximum pixel error\n      const a = 2 * this.triangles[t * 3 + 0];\n      const b = 2 * this.triangles[t * 3 + 1];\n      const c = 2 * this.triangles[t * 3 + 2];\n      this._findCandidate(\n        coords[a],\n        coords[a + 1],\n        coords[b],\n        coords[b + 1],\n        coords[c],\n        coords[c + 1],\n        t\n      );\n    }\n    this._pendingLen = 0;\n  }\n\n  // rasterize a triangle, find its max error, and queue it for processing\n  _findCandidate(p0x, p0y, p1x, p1y, p2x, p2y, t) {\n    // triangle bounding box\n    const minX = Math.min(p0x, p1x, p2x);\n    const minY = Math.min(p0y, p1y, p2y);\n    const maxX = Math.max(p0x, p1x, p2x);\n    const maxY = Math.max(p0y, p1y, p2y);\n\n    // forward differencing variables\n    let w00 = orient(p1x, p1y, p2x, p2y, minX, minY);\n    let w01 = orient(p2x, p2y, p0x, p0y, minX, minY);\n    let w02 = orient(p0x, p0y, p1x, p1y, minX, minY);\n    const a01 = p1y - p0y;\n    const b01 = p0x - p1x;\n    const a12 = p2y - p1y;\n    const b12 = p1x - p2x;\n    const a20 = p0y - p2y;\n    const b20 = p2x - p0x;\n\n    // pre-multiplied z values at vertices\n    const a = orient(p0x, p0y, p1x, p1y, p2x, p2y);\n    const z0 = this.heightAt(p0x, p0y) / a;\n    const z1 = this.heightAt(p1x, p1y) / a;\n    const z2 = this.heightAt(p2x, p2y) / a;\n\n    // iterate over pixels in bounding box\n    let maxError = 0;\n    let mx = 0;\n    let my = 0;\n    let rms = 0;\n    for (let y = minY; y <= maxY; y++) {\n      // compute starting offset\n      let dx = 0;\n      if (w00 < 0 && a12 !== 0) {\n        dx = Math.max(dx, Math.floor(-w00 / a12));\n      }\n      if (w01 < 0 && a20 !== 0) {\n        dx = Math.max(dx, Math.floor(-w01 / a20));\n      }\n      if (w02 < 0 && a01 !== 0) {\n        dx = Math.max(dx, Math.floor(-w02 / a01));\n      }\n\n      let w0 = w00 + a12 * dx;\n      let w1 = w01 + a20 * dx;\n      let w2 = w02 + a01 * dx;\n\n      let wasInside = false;\n\n      for (let x = minX + dx; x <= maxX; x++) {\n        // check if inside triangle\n        if (w0 >= 0 && w1 >= 0 && w2 >= 0) {\n          wasInside = true;\n\n          // compute z using barycentric coordinates\n          const z = z0 * w0 + z1 * w1 + z2 * w2;\n          const dz = Math.abs(z - this.heightAt(x, y));\n          rms += dz * dz;\n          if (dz > maxError) {\n            maxError = dz;\n            mx = x;\n            my = y;\n          }\n        } else if (wasInside) {\n          break;\n        }\n\n        w0 += a12;\n        w1 += a20;\n        w2 += a01;\n      }\n\n      w00 += b12;\n      w01 += b20;\n      w02 += b01;\n    }\n\n    if ((mx === p0x && my === p0y) || (mx === p1x && my === p1y) || (mx === p2x && my === p2y)) {\n      maxError = 0;\n    }\n\n    // update triangle metadata\n    this._candidates[2 * t] = mx;\n    this._candidates[2 * t + 1] = my;\n    this._rms[t] = rms;\n\n    // add triangle to priority queue\n    this._queuePush(t, maxError, rms);\n  }\n\n  // process the next triangle in the queue, splitting it with a new point\n  _step() {\n    // pop triangle with highest error from priority queue\n    const t = this._queuePop();\n\n    const e0 = t * 3 + 0;\n    const e1 = t * 3 + 1;\n    const e2 = t * 3 + 2;\n\n    const p0 = this.triangles[e0];\n    const p1 = this.triangles[e1];\n    const p2 = this.triangles[e2];\n\n    const ax = this.coords[2 * p0];\n    const ay = this.coords[2 * p0 + 1];\n    const bx = this.coords[2 * p1];\n    const by = this.coords[2 * p1 + 1];\n    const cx = this.coords[2 * p2];\n    const cy = this.coords[2 * p2 + 1];\n    const px = this._candidates[2 * t];\n    const py = this._candidates[2 * t + 1];\n\n    const pn = this._addPoint(px, py);\n\n    if (orient(ax, ay, bx, by, px, py) === 0) {\n      this._handleCollinear(pn, e0);\n    } else if (orient(bx, by, cx, cy, px, py) === 0) {\n      this._handleCollinear(pn, e1);\n    } else if (orient(cx, cy, ax, ay, px, py) === 0) {\n      this._handleCollinear(pn, e2);\n    } else {\n      const h0 = this._halfedges[e0];\n      const h1 = this._halfedges[e1];\n      const h2 = this._halfedges[e2];\n\n      const t0 = this._addTriangle(p0, p1, pn, h0, -1, -1, e0);\n      const t1 = this._addTriangle(p1, p2, pn, h1, -1, t0 + 1);\n      const t2 = this._addTriangle(p2, p0, pn, h2, t0 + 2, t1 + 1);\n\n      this._legalize(t0);\n      this._legalize(t1);\n      this._legalize(t2);\n    }\n  }\n\n  // add coordinates for a new vertex\n  _addPoint(x, y) {\n    const i = this.coords.length >> 1;\n    this.coords.push(x, y);\n    return i;\n  }\n\n  // add or update a triangle in the mesh\n  _addTriangle(a, b, c, ab, bc, ca, e = this.triangles.length) {\n    const t = e / 3; // new triangle index\n\n    // add triangle vertices\n    this.triangles[e + 0] = a;\n    this.triangles[e + 1] = b;\n    this.triangles[e + 2] = c;\n\n    // add triangle halfedges\n    this._halfedges[e + 0] = ab;\n    this._halfedges[e + 1] = bc;\n    this._halfedges[e + 2] = ca;\n\n    // link neighboring halfedges\n    if (ab >= 0) {\n      this._halfedges[ab] = e + 0;\n    }\n    if (bc >= 0) {\n      this._halfedges[bc] = e + 1;\n    }\n    if (ca >= 0) {\n      this._halfedges[ca] = e + 2;\n    }\n\n    // init triangle metadata\n    this._candidates[2 * t + 0] = 0;\n    this._candidates[2 * t + 1] = 0;\n    this._queueIndices[t] = -1;\n    this._rms[t] = 0;\n\n    // add triangle to pending queue for later rasterization\n    this._pending[this._pendingLen++] = t;\n\n    // return first halfedge index\n    return e;\n  }\n\n  _legalize(a) {\n    // if the pair of triangles doesn't satisfy the Delaunay condition\n    // (p1 is inside the circumcircle of [p0, pl, pr]), flip them,\n    // then do the same check/flip recursively for the new pair of triangles\n    //\n    //           pl                    pl\n    //          /||\\                  /  \\\n    //       al/ || \\bl            al/    \\a\n    //        /  ||  \\              /      \\\n    //       /  a||b  \\    flip    /___ar___\\\n    //     p0\\   ||   /p1   =>   p0\\---bl---/p1\n    //        \\  ||  /              \\      /\n    //       ar\\ || /br             b\\    /br\n    //          \\||/                  \\  /\n    //           pr                    pr\n\n    const b = this._halfedges[a];\n\n    if (b < 0) {\n      return;\n    }\n\n    const a0 = a - (a % 3);\n    const b0 = b - (b % 3);\n    const al = a0 + ((a + 1) % 3);\n    const ar = a0 + ((a + 2) % 3);\n    const bl = b0 + ((b + 2) % 3);\n    const br = b0 + ((b + 1) % 3);\n    const p0 = this.triangles[ar];\n    const pr = this.triangles[a];\n    const pl = this.triangles[al];\n    const p1 = this.triangles[bl];\n    const coords = this.coords;\n\n    if (\n      !inCircle(\n        coords[2 * p0],\n        coords[2 * p0 + 1],\n        coords[2 * pr],\n        coords[2 * pr + 1],\n        coords[2 * pl],\n        coords[2 * pl + 1],\n        coords[2 * p1],\n        coords[2 * p1 + 1]\n      )\n    ) {\n      return;\n    }\n\n    const hal = this._halfedges[al];\n    const har = this._halfedges[ar];\n    const hbl = this._halfedges[bl];\n    const hbr = this._halfedges[br];\n\n    this._queueRemove(a0 / 3);\n    this._queueRemove(b0 / 3);\n\n    const t0 = this._addTriangle(p0, p1, pl, -1, hbl, hal, a0);\n    const t1 = this._addTriangle(p1, p0, pr, t0, har, hbr, b0);\n\n    this._legalize(t0 + 1);\n    this._legalize(t1 + 2);\n  }\n\n  // handle a case where new vertex is on the edge of a triangle\n  _handleCollinear(pn, a) {\n    const a0 = a - (a % 3);\n    const al = a0 + ((a + 1) % 3);\n    const ar = a0 + ((a + 2) % 3);\n    const p0 = this.triangles[ar];\n    const pr = this.triangles[a];\n    const pl = this.triangles[al];\n    const hal = this._halfedges[al];\n    const har = this._halfedges[ar];\n\n    const b = this._halfedges[a];\n\n    if (b < 0) {\n      const t0 = this._addTriangle(pn, p0, pr, -1, har, -1, a0);\n      const t1 = this._addTriangle(p0, pn, pl, t0, -1, hal);\n      this._legalize(t0 + 1);\n      this._legalize(t1 + 2);\n      return;\n    }\n\n    const b0 = b - (b % 3);\n    const bl = b0 + ((b + 2) % 3);\n    const br = b0 + ((b + 1) % 3);\n    const p1 = this.triangles[bl];\n    const hbl = this._halfedges[bl];\n    const hbr = this._halfedges[br];\n\n    this._queueRemove(b0 / 3);\n\n    const t0 = this._addTriangle(p0, pr, pn, har, -1, -1, a0);\n    const t1 = this._addTriangle(pr, p1, pn, hbr, -1, t0 + 1, b0);\n    const t2 = this._addTriangle(p1, pl, pn, hbl, -1, t1 + 1);\n    const t3 = this._addTriangle(pl, p0, pn, hal, t0 + 2, t2 + 1);\n\n    this._legalize(t0);\n    this._legalize(t1);\n    this._legalize(t2);\n    this._legalize(t3);\n  }\n\n  // priority queue methods\n\n  _queuePush(t, error, rms) {\n    const i = this._queue.length;\n    this._queueIndices[t] = i;\n    this._queue.push(t);\n    this._errors.push(error);\n    this._rmsSum += rms;\n    this._queueUp(i);\n  }\n\n  _queuePop() {\n    const n = this._queue.length - 1;\n    this._queueSwap(0, n);\n    this._queueDown(0, n);\n    return this._queuePopBack();\n  }\n\n  _queuePopBack() {\n    const t = this._queue.pop();\n    this._errors.pop();\n    this._rmsSum -= this._rms[t];\n    this._queueIndices[t] = -1;\n    return t;\n  }\n\n  _queueRemove(t) {\n    const i = this._queueIndices[t];\n    if (i < 0) {\n      const it = this._pending.indexOf(t);\n      if (it !== -1) {\n        this._pending[it] = this._pending[--this._pendingLen];\n      } else {\n        throw new Error('Broken triangulation (something went wrong).');\n      }\n      return;\n    }\n    const n = this._queue.length - 1;\n    if (n !== i) {\n      this._queueSwap(i, n);\n      if (!this._queueDown(i, n)) {\n        this._queueUp(i);\n      }\n    }\n    this._queuePopBack();\n  }\n\n  _queueLess(i, j) {\n    return this._errors[i] > this._errors[j];\n  }\n\n  _queueSwap(i, j) {\n    const pi = this._queue[i];\n    const pj = this._queue[j];\n    this._queue[i] = pj;\n    this._queue[j] = pi;\n    this._queueIndices[pi] = j;\n    this._queueIndices[pj] = i;\n    const e = this._errors[i];\n    this._errors[i] = this._errors[j];\n    this._errors[j] = e;\n  }\n\n  _queueUp(j0) {\n    let j = j0;\n    while (true) {\n      const i = (j - 1) >> 1;\n      if (i === j || !this._queueLess(j, i)) {\n        break;\n      }\n      this._queueSwap(i, j);\n      j = i;\n    }\n  }\n\n  _queueDown(i0, n) {\n    let i = i0;\n    while (true) {\n      const j1 = 2 * i + 1;\n      if (j1 >= n || j1 < 0) {\n        break;\n      }\n      const j2 = j1 + 1;\n      let j = j1;\n      if (j2 < n && this._queueLess(j2, j1)) {\n        j = j2;\n      }\n      if (!this._queueLess(j, i)) {\n        break;\n      }\n      this._queueSwap(i, j);\n      i = j;\n    }\n    return i > i0;\n  }\n}\n\nfunction orient(ax, ay, bx, by, cx, cy) {\n  return (bx - cx) * (ay - cy) - (by - cy) * (ax - cx);\n}\n\nfunction inCircle(ax, ay, bx, by, cx, cy, px, py) {\n  const dx = ax - px;\n  const dy = ay - py;\n  const ex = bx - px;\n  const ey = by - py;\n  const fx = cx - px;\n  const fy = cy - py;\n\n  const ap = dx * dx + dy * dy;\n  const bp = ex * ex + ey * ey;\n  const cp = fx * fx + fy * fy;\n\n  return dx * (ey * cp - bp * fy) - dy * (ex * cp - bp * fx) + ap * (ex * fy - ey * fx) < 0;\n}\n"]},"metadata":{},"sourceType":"module"}