{"ast":null,"code":"import { TILE3D_OPTIMIZATION_HINT, TILE_REFINEMENT } from '../../constants';\nimport TilesetTraverser from './tileset-traverser';\nexport default class Tileset3DTraverser extends TilesetTraverser {\n  compareDistanceToCamera(a, b) {\n    return b._distanceToCamera === 0 && a._distanceToCamera === 0 ? b._centerZDepth - a._centerZDepth : b._distanceToCamera - a._distanceToCamera;\n  }\n\n  updateTileVisibility(tile, frameState) {\n    super.updateTileVisibility(tile, frameState);\n\n    if (!tile.isVisibleAndInRequestVolume) {\n      return;\n    }\n\n    const hasChildren = tile.children.length > 0;\n\n    if (tile.hasTilesetContent && hasChildren) {\n      const firstChild = tile.children[0];\n      this.updateTileVisibility(firstChild, frameState);\n      tile._visible = firstChild._visible;\n      return;\n    }\n\n    if (this.meetsScreenSpaceErrorEarly(tile, frameState)) {\n      tile._visible = false;\n      return;\n    }\n\n    const replace = tile.refine === TILE_REFINEMENT.REPLACE;\n    const useOptimization = tile._optimChildrenWithinParent === TILE3D_OPTIMIZATION_HINT.USE_OPTIMIZATION;\n\n    if (replace && useOptimization && hasChildren) {\n      if (!this.anyChildrenVisible(tile, frameState)) {\n        tile._visible = false;\n        return;\n      }\n    }\n  }\n\n  meetsScreenSpaceErrorEarly(tile, frameState) {\n    const {\n      parent\n    } = tile;\n\n    if (!parent || parent.hasTilesetContent || parent.refine !== TILE_REFINEMENT.ADD) {\n      return false;\n    }\n\n    return !this.shouldRefine(tile, frameState, true);\n  }\n\n}","map":{"version":3,"mappings":"AAGA,SAAQA,wBAAR,EAAkCC,eAAlC,QAAwD,iBAAxD;AACA,OAAOC,gBAAP,MAA6B,qBAA7B;AAEA,eAAe,MAAMC,kBAAN,SAAiCD,gBAAjC,CAAkD;EAC/DE,uBAAuB,CAACC,CAAD,EAAIC,CAAJ,EAAO;IAE5B,OAAOA,CAAC,CAACC,iBAAFD,KAAwB,CAAxBA,IAA6BD,CAAC,CAACE,iBAAFF,KAAwB,CAArDC,GACHA,CAAC,CAACE,aAAFF,GAAkBD,CAAC,CAACG,aADjBF,GAEHA,CAAC,CAACC,iBAAFD,GAAsBD,CAAC,CAACE,iBAF5B;EAGD;;EAEDE,oBAAoB,CAACC,IAAD,EAAOC,UAAP,EAAmB;IACrC,MAAMF,oBAAN,CAA2BC,IAA3B,EAAiCC,UAAjC;;IAGA,IAAI,CAACD,IAAI,CAACE,2BAAV,EAAuC;MACrC;IACD;;IAED,MAAMC,WAAW,GAAGH,IAAI,CAACI,QAALJ,CAAcK,MAAdL,GAAuB,CAA3C;;IACA,IAAIA,IAAI,CAACM,iBAALN,IAA0BG,WAA9B,EAA2C;MAIzC,MAAMI,UAAU,GAAGP,IAAI,CAACI,QAALJ,CAAc,CAAdA,CAAnB;MACA,KAAKD,oBAAL,CAA0BQ,UAA1B,EAAsCN,UAAtC;MACAD,IAAI,CAACQ,QAALR,GAAgBO,UAAU,CAACC,QAA3BR;MACA;IACD;;IAED,IAAI,KAAKS,0BAAL,CAAgCT,IAAhC,EAAsCC,UAAtC,CAAJ,EAAuD;MACrDD,IAAI,CAACQ,QAALR,GAAgB,KAAhBA;MACA;IACD;;IAED,MAAMU,OAAO,GAAGV,IAAI,CAACW,MAALX,KAAgBT,eAAe,CAACqB,OAAhD;IACA,MAAMC,eAAe,GACnBb,IAAI,CAACc,0BAALd,KAAoCV,wBAAwB,CAACyB,gBAD/D;;IAEA,IAAIL,OAAO,IAAIG,eAAXH,IAA8BP,WAAlC,EAA+C;MAC7C,IAAI,CAAC,KAAKa,kBAAL,CAAwBhB,IAAxB,EAA8BC,UAA9B,CAAL,EAAgD;QAC9CD,IAAI,CAACQ,QAALR,GAAgB,KAAhBA;QACA;MACD;IACF;EACF;;EAEDS,0BAA0B,CAACT,IAAD,EAAOC,UAAP,EAAmB;IAC3C,MAAM;MAACgB;IAAD,IAAWjB,IAAjB;;IACA,IAAI,CAACiB,MAAD,IAAWA,MAAM,CAACX,iBAAlB,IAAuCW,MAAM,CAACN,MAAPM,KAAkB1B,eAAe,CAAC2B,GAA7E,EAAkF;MAChF,OAAO,KAAP;IACD;;IAGD,OAAO,CAAC,KAAKC,YAAL,CAAkBnB,IAAlB,EAAwBC,UAAxB,EAAoC,IAApC,CAAR;EACD;;AAnD8D","names":["TILE3D_OPTIMIZATION_HINT","TILE_REFINEMENT","TilesetTraverser","Tileset3DTraverser","compareDistanceToCamera","a","b","_distanceToCamera","_centerZDepth","updateTileVisibility","tile","frameState","isVisibleAndInRequestVolume","hasChildren","children","length","hasTilesetContent","firstChild","_visible","meetsScreenSpaceErrorEarly","replace","refine","REPLACE","useOptimization","_optimChildrenWithinParent","USE_OPTIMIZATION","anyChildrenVisible","parent","ADD","shouldRefine"],"sources":["../../../../src/tileset/traversers/tileset-3d-traverser.ts"],"sourcesContent":["// This file is derived from the Cesium code base under Apache 2 license\n// See LICENSE.md and https://github.com/AnalyticalGraphicsInc/cesium/blob/master/LICENSE.md\n\nimport {TILE3D_OPTIMIZATION_HINT, TILE_REFINEMENT} from '../../constants';\nimport TilesetTraverser from './tileset-traverser';\n\nexport default class Tileset3DTraverser extends TilesetTraverser {\n  compareDistanceToCamera(a, b) {\n    // Sort by farthest child first since this is going on a stack\n    return b._distanceToCamera === 0 && a._distanceToCamera === 0\n      ? b._centerZDepth - a._centerZDepth\n      : b._distanceToCamera - a._distanceToCamera;\n  }\n\n  updateTileVisibility(tile, frameState) {\n    super.updateTileVisibility(tile, frameState);\n\n    //  Optimization - if none of the tile's children are visible then this tile isn't visible\n    if (!tile.isVisibleAndInRequestVolume) {\n      return;\n    }\n\n    const hasChildren = tile.children.length > 0;\n    if (tile.hasTilesetContent && hasChildren) {\n      // Use the root tile's visibility instead of this tile's visibility.\n      // The root tile may be culled by the children bounds optimization in which\n      // case this tile should also be culled.\n      const firstChild = tile.children[0];\n      this.updateTileVisibility(firstChild, frameState);\n      tile._visible = firstChild._visible;\n      return;\n    }\n\n    if (this.meetsScreenSpaceErrorEarly(tile, frameState)) {\n      tile._visible = false;\n      return;\n    }\n\n    const replace = tile.refine === TILE_REFINEMENT.REPLACE;\n    const useOptimization =\n      tile._optimChildrenWithinParent === TILE3D_OPTIMIZATION_HINT.USE_OPTIMIZATION;\n    if (replace && useOptimization && hasChildren) {\n      if (!this.anyChildrenVisible(tile, frameState)) {\n        tile._visible = false;\n        return;\n      }\n    }\n  }\n\n  meetsScreenSpaceErrorEarly(tile, frameState) {\n    const {parent} = tile;\n    if (!parent || parent.hasTilesetContent || parent.refine !== TILE_REFINEMENT.ADD) {\n      return false;\n    }\n\n    // Use parent's geometric error with child's box to see if the tile already meet the SSE\n    return !this.shouldRefine(tile, frameState, true);\n  }\n}\n"]},"metadata":{},"sourceType":"module"}