{"ast":null,"code":"import { global, isBrowser as getIsBrowser } from 'probe.gl/env';\nimport { trackContextState } from '../state-tracker/track-context-state';\nimport { log } from '../utils/log';\nimport { assert } from '../utils/assert';\nimport { getDevicePixelRatio } from '../utils/device-pixels';\nimport { isWebGL2 } from '../utils/webgl-checks';\nconst isBrowser = getIsBrowser();\nconst isPage = isBrowser && typeof document !== 'undefined';\nconst CONTEXT_DEFAULTS = {\n  webgl2: true,\n  webgl1: true,\n  throwOnError: true,\n  manageState: true,\n  canvas: null,\n  debug: false,\n  width: 800,\n  height: 600\n};\nexport function createGLContext() {\n  let options = arguments.length > 0 && arguments[0] !== undefined ? arguments[0] : {};\n  assert(isBrowser, \"createGLContext only available in the browser.\\nCreate your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils\");\n  options = Object.assign({}, CONTEXT_DEFAULTS, options);\n  const {\n    width,\n    height\n  } = options;\n\n  function onError(message) {\n    if (options.throwOnError) {\n      throw new Error(message);\n    }\n\n    console.error(message);\n    return null;\n  }\n\n  options.onError = onError;\n  let gl;\n  const {\n    canvas\n  } = options;\n  const targetCanvas = getCanvas({\n    canvas,\n    width,\n    height,\n    onError\n  });\n  gl = createBrowserContext(targetCanvas, options);\n\n  if (!gl) {\n    return null;\n  }\n\n  gl = instrumentGLContext(gl, options);\n  logInfo(gl);\n  return gl;\n}\nexport function instrumentGLContext(gl) {\n  let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n  if (!gl || gl._instrumented) {\n    return gl;\n  }\n\n  gl._version = gl._version || getVersion(gl);\n  gl.luma = gl.luma || {};\n  gl.luma.canvasSizeInfo = gl.luma.canvasSizeInfo || {};\n  options = Object.assign({}, CONTEXT_DEFAULTS, options);\n  const {\n    manageState,\n    debug\n  } = options;\n\n  if (manageState) {\n    trackContextState(gl, {\n      copyState: false,\n      log: function () {\n        for (var _len = arguments.length, args = new Array(_len), _key = 0; _key < _len; _key++) {\n          args[_key] = arguments[_key];\n        }\n\n        return log.log(1, ...args)();\n      }\n    });\n  }\n\n  if (isBrowser && debug) {\n    if (!global.makeDebugContext) {\n      log.warn('WebGL debug mode not activated. import \"@luma.gl/debug\" to enable.')();\n    } else {\n      gl = global.makeDebugContext(gl, options);\n      log.level = Math.max(log.level, 1);\n    }\n  }\n\n  gl._instrumented = true;\n  return gl;\n}\nexport function getContextDebugInfo(gl) {\n  const vendorMasked = gl.getParameter(7936);\n  const rendererMasked = gl.getParameter(7937);\n  const ext = gl.getExtension('WEBGL_debug_renderer_info');\n  const vendorUnmasked = ext && gl.getParameter(ext.UNMASKED_VENDOR_WEBGL || 7936);\n  const rendererUnmasked = ext && gl.getParameter(ext.UNMASKED_RENDERER_WEBGL || 7937);\n  return {\n    vendor: vendorUnmasked || vendorMasked,\n    renderer: rendererUnmasked || rendererMasked,\n    vendorMasked,\n    rendererMasked,\n    version: gl.getParameter(7938),\n    shadingLanguageVersion: gl.getParameter(35724)\n  };\n}\nexport function resizeGLContext(gl) {\n  let options = arguments.length > 1 && arguments[1] !== undefined ? arguments[1] : {};\n\n  if (gl.canvas) {\n    const devicePixelRatio = getDevicePixelRatio(options.useDevicePixels);\n    setDevicePixelRatio(gl, devicePixelRatio, options);\n    return;\n  }\n\n  const ext = gl.getExtension('STACKGL_resize_drawingbuffer');\n\n  if (ext && `width` in options && `height` in options) {\n    ext.resize(options.width, options.height);\n  }\n}\n\nfunction createBrowserContext(canvas, options) {\n  const {\n    onError\n  } = options;\n  let errorMessage = null;\n\n  const onCreateError = error => errorMessage = error.statusMessage || errorMessage;\n\n  canvas.addEventListener('webglcontextcreationerror', onCreateError, false);\n  const {\n    webgl1 = true,\n    webgl2 = true\n  } = options;\n  let gl = null;\n\n  if (webgl2) {\n    gl = gl || canvas.getContext('webgl2', options);\n    gl = gl || canvas.getContext('experimental-webgl2', options);\n  }\n\n  if (webgl1) {\n    gl = gl || canvas.getContext('webgl', options);\n    gl = gl || canvas.getContext('experimental-webgl', options);\n  }\n\n  canvas.removeEventListener('webglcontextcreationerror', onCreateError, false);\n\n  if (!gl) {\n    return onError(`Failed to create ${webgl2 && !webgl1 ? 'WebGL2' : 'WebGL'} context: ${errorMessage || 'Unknown error'}`);\n  }\n\n  if (options.onContextLost) {\n    canvas.addEventListener('webglcontextlost', options.onContextLost, false);\n  }\n\n  if (options.onContextRestored) {\n    canvas.addEventListener('webglcontextrestored', options.onContextRestored, false);\n  }\n\n  return gl;\n}\n\nfunction getCanvas(_ref) {\n  let {\n    canvas,\n    width = 800,\n    height = 600,\n    onError\n  } = _ref;\n  let targetCanvas;\n\n  if (typeof canvas === 'string') {\n    const isPageLoaded = isPage && document.readyState === 'complete';\n\n    if (!isPageLoaded) {\n      onError(`createGLContext called on canvas '${canvas}' before page was loaded`);\n    }\n\n    targetCanvas = document.getElementById(canvas);\n  } else if (canvas) {\n    targetCanvas = canvas;\n  } else {\n    targetCanvas = document.createElement('canvas');\n    targetCanvas.id = 'lumagl-canvas';\n    targetCanvas.style.width = Number.isFinite(width) ? `${width}px` : '100%';\n    targetCanvas.style.height = Number.isFinite(height) ? `${height}px` : '100%';\n    document.body.insertBefore(targetCanvas, document.body.firstChild);\n  }\n\n  return targetCanvas;\n}\n\nfunction logInfo(gl) {\n  const webGL = isWebGL2(gl) ? 'WebGL2' : 'WebGL1';\n  const info = getContextDebugInfo(gl);\n  const driver = info ? `(${info.vendor},${info.renderer})` : '';\n  const debug = gl.debug ? ' debug' : '';\n  log.info(1, `${webGL}${debug} context ${driver}`)();\n}\n\nfunction getVersion(gl) {\n  if (typeof WebGL2RenderingContext !== 'undefined' && gl instanceof WebGL2RenderingContext) {\n    return 2;\n  }\n\n  return 1;\n}\n\nfunction setDevicePixelRatio(gl, devicePixelRatio, options) {\n  let clientWidth = 'width' in options ? options.width : gl.canvas.clientWidth;\n  let clientHeight = 'height' in options ? options.height : gl.canvas.clientHeight;\n\n  if (!clientWidth || !clientHeight) {\n    log.log(1, 'Canvas clientWidth/clientHeight is 0')();\n    devicePixelRatio = 1;\n    clientWidth = gl.canvas.width || 1;\n    clientHeight = gl.canvas.height || 1;\n  }\n\n  gl.luma = gl.luma || {};\n  gl.luma.canvasSizeInfo = gl.luma.canvasSizeInfo || {};\n  const cachedSize = gl.luma.canvasSizeInfo;\n\n  if (cachedSize.clientWidth !== clientWidth || cachedSize.clientHeight !== clientHeight || cachedSize.devicePixelRatio !== devicePixelRatio) {\n    let clampedPixelRatio = devicePixelRatio;\n    const canvasWidth = Math.floor(clientWidth * clampedPixelRatio);\n    const canvasHeight = Math.floor(clientHeight * clampedPixelRatio);\n    gl.canvas.width = canvasWidth;\n    gl.canvas.height = canvasHeight;\n\n    if (gl.drawingBufferWidth !== canvasWidth || gl.drawingBufferHeight !== canvasHeight) {\n      log.warn(`Device pixel ratio clamped`)();\n      clampedPixelRatio = Math.min(gl.drawingBufferWidth / clientWidth, gl.drawingBufferHeight / clientHeight);\n      gl.canvas.width = Math.floor(clientWidth * clampedPixelRatio);\n      gl.canvas.height = Math.floor(clientHeight * clampedPixelRatio);\n    }\n\n    Object.assign(gl.luma.canvasSizeInfo, {\n      clientWidth,\n      clientHeight,\n      devicePixelRatio\n    });\n  }\n}","map":{"version":3,"mappings":"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","names":["global","isBrowser","getIsBrowser","trackContextState","log","assert","getDevicePixelRatio","isWebGL2","isPage","document","CONTEXT_DEFAULTS","webgl2","webgl1","throwOnError","manageState","canvas","debug","width","height","createGLContext","options","Object","assign","onError","message","Error","console","error","gl","targetCanvas","getCanvas","createBrowserContext","instrumentGLContext","logInfo","_instrumented","_version","getVersion","luma","canvasSizeInfo","copyState","args","makeDebugContext","warn","level","Math","max","getContextDebugInfo","vendorMasked","getParameter","rendererMasked","ext","getExtension","vendorUnmasked","UNMASKED_VENDOR_WEBGL","rendererUnmasked","UNMASKED_RENDERER_WEBGL","vendor","renderer","version","shadingLanguageVersion","resizeGLContext","devicePixelRatio","useDevicePixels","setDevicePixelRatio","resize","errorMessage","onCreateError","statusMessage","addEventListener","getContext","removeEventListener","onContextLost","onContextRestored","isPageLoaded","readyState","getElementById","createElement","id","style","Number","isFinite","body","insertBefore","firstChild","webGL","info","driver","WebGL2RenderingContext","clientWidth","clientHeight","cachedSize","clampedPixelRatio","canvasWidth","floor","canvasHeight","drawingBufferWidth","drawingBufferHeight","min"],"sources":["../../../src/context/context.js"],"sourcesContent":["// WebGLRenderingContext related methods\n\n/** @typedef {import('./context')} types */\n\n/* eslint-disable quotes */\nimport GL from '@luma.gl/constants';\nimport {global, isBrowser as getIsBrowser} from 'probe.gl/env';\nimport {trackContextState} from '../state-tracker/track-context-state';\n\nimport {log} from '../utils/log';\nimport {assert} from '../utils/assert';\nimport {getDevicePixelRatio} from '../utils/device-pixels';\nimport {isWebGL2} from '../utils/webgl-checks';\n\nconst isBrowser = getIsBrowser();\nconst isPage = isBrowser && typeof document !== 'undefined';\n\nconst CONTEXT_DEFAULTS = {\n  // COMMON CONTEXT PARAMETERS\n  // Attempt to allocate WebGL2 context\n  webgl2: true, // Attempt to create a WebGL2 context (false to force webgl1)\n  webgl1: true, // Attempt to create a WebGL1 context (false to fail if webgl2 not available)\n  throwOnError: true,\n  manageState: true,\n  // BROWSER CONTEXT PARAMETERS\n  canvas: null, // A canvas element or a canvas string id\n  debug: false, // Instrument context (at the expense of performance)\n  // HEADLESS CONTEXT PARAMETERS\n  width: 800, // width are height are only used by headless gl\n  height: 600\n  // WEBGL/HEADLESS CONTEXT PARAMETERS\n  // Remaining options are passed through to context creator\n};\n\n/**\n * Creates a context giving access to the WebGL API\n * @type {types['createGLContext']}\n */\n/* eslint-disable complexity, max-statements */\nexport function createGLContext(options = {}) {\n  assert(\n    isBrowser,\n    \"createGLContext only available in the browser.\\nCreate your own headless context or use 'createHeadlessContext' from @luma.gl/test-utils\"\n  );\n\n  options = Object.assign({}, CONTEXT_DEFAULTS, options);\n  const {width, height} = options;\n\n  // Error reporting function, enables exceptions to be disabled\n  function onError(message) {\n    if (options.throwOnError) {\n      throw new Error(message);\n    }\n    // eslint-disable-next-line\n    console.error(message);\n    return null;\n  }\n  options.onError = onError;\n\n  let gl;\n  // Get or create a canvas\n  const {canvas} = options;\n  const targetCanvas = getCanvas({canvas, width, height, onError});\n  // Create a WebGL context in the canvas\n  gl = createBrowserContext(targetCanvas, options);\n\n  if (!gl) {\n    return null;\n  }\n\n  gl = instrumentGLContext(gl, options);\n\n  // Log some debug info about the newly created context\n  logInfo(gl);\n\n  // Add to seer integration\n  return gl;\n}\n\n/**\n * Creates a context giving access to the WebGL API\n * @type {types['instrumentGLContext']}\n */\nexport function instrumentGLContext(gl, options = {}) {\n  // Avoid multiple instrumentations\n  // @ts-ignore\n  if (!gl || gl._instrumented) {\n    return gl;\n  }\n\n  // @ts-ignore\n  gl._version = gl._version || getVersion(gl);\n\n  // Cache canvas size information to avoid setting it on every frame.\n  // @ts-ignore\n  gl.luma = gl.luma || {};\n  // @ts-ignore\n  gl.luma.canvasSizeInfo = gl.luma.canvasSizeInfo || {};\n\n  options = Object.assign({}, CONTEXT_DEFAULTS, options);\n  const {manageState, debug} = options;\n\n  // Install context state tracking\n  if (manageState) {\n    trackContextState(gl, {\n      copyState: false,\n      log: (...args) => log.log(1, ...args)()\n    });\n  }\n\n  // Add debug instrumentation to the context\n  if (isBrowser && debug) {\n    // @ts-ignore\n    if (!global.makeDebugContext) {\n      log.warn('WebGL debug mode not activated. import \"@luma.gl/debug\" to enable.')();\n    } else {\n      // @ts-ignore\n      gl = global.makeDebugContext(gl, options);\n      // Debug forces log level to at least 1\n      log.level = Math.max(log.level, 1);\n    }\n  }\n\n  // @ts-ignore\n  gl._instrumented = true;\n\n  return gl;\n}\n\n/**\n * Provides strings identifying the GPU vendor and driver.\n * @type {types['getContextDebugInfo']}\n */\nexport function getContextDebugInfo(gl) {\n  const vendorMasked = gl.getParameter(GL.VENDOR);\n  const rendererMasked = gl.getParameter(GL.RENDERER);\n  const ext = gl.getExtension('WEBGL_debug_renderer_info');\n  const vendorUnmasked = ext && gl.getParameter(ext.UNMASKED_VENDOR_WEBGL || GL.VENDOR);\n  const rendererUnmasked = ext && gl.getParameter(ext.UNMASKED_RENDERER_WEBGL || GL.RENDERER);\n  return {\n    vendor: vendorUnmasked || vendorMasked,\n    renderer: rendererUnmasked || rendererMasked,\n    vendorMasked,\n    rendererMasked,\n    version: gl.getParameter(GL.VERSION),\n    shadingLanguageVersion: gl.getParameter(GL.SHADING_LANGUAGE_VERSION)\n  };\n}\n\n/**\n * Resize the canvas' drawing buffer.\n * @type {types['resizeGLContext']}\n */\nexport function resizeGLContext(gl, options = {}) {\n  // Resize browser context\n  if (gl.canvas) {\n    const devicePixelRatio = getDevicePixelRatio(options.useDevicePixels);\n    setDevicePixelRatio(gl, devicePixelRatio, options);\n    return;\n  }\n\n  // Resize headless gl context\n  const ext = gl.getExtension('STACKGL_resize_drawingbuffer');\n  if (ext && `width` in options && `height` in options) {\n    ext.resize(options.width, options.height);\n  }\n}\n\n// HELPER METHODS\n\n/**\n * Create a WebGL context for a canvas\n * Note calling this multiple time on the same canvas does return the same context\n */\n\nfunction createBrowserContext(canvas, options) {\n  const {onError} = options;\n\n  // Try to extract any extra information about why context creation failed\n  let errorMessage = null;\n  const onCreateError = error => (errorMessage = error.statusMessage || errorMessage);\n  canvas.addEventListener('webglcontextcreationerror', onCreateError, false);\n\n  const {webgl1 = true, webgl2 = true} = options;\n  let gl = null;\n  // Prefer webgl2 over webgl1, prefer conformant over experimental\n  if (webgl2) {\n    gl = gl || canvas.getContext('webgl2', options);\n    gl = gl || canvas.getContext('experimental-webgl2', options);\n  }\n  if (webgl1) {\n    gl = gl || canvas.getContext('webgl', options);\n    gl = gl || canvas.getContext('experimental-webgl', options);\n  }\n\n  canvas.removeEventListener('webglcontextcreationerror', onCreateError, false);\n\n  if (!gl) {\n    return onError(\n      `Failed to create ${webgl2 && !webgl1 ? 'WebGL2' : 'WebGL'} context: ${errorMessage ||\n        'Unknown error'}`\n    );\n  }\n\n  if (options.onContextLost) {\n    canvas.addEventListener('webglcontextlost', options.onContextLost, false);\n  }\n\n  if (options.onContextRestored) {\n    canvas.addEventListener('webglcontextrestored', options.onContextRestored, false);\n  }\n\n  return gl;\n}\n\nfunction getCanvas({canvas, width = 800, height = 600, onError}) {\n  let targetCanvas;\n  if (typeof canvas === 'string') {\n    const isPageLoaded = isPage && document.readyState === 'complete';\n    if (!isPageLoaded) {\n      onError(`createGLContext called on canvas '${canvas}' before page was loaded`);\n    }\n    targetCanvas = document.getElementById(canvas);\n  } else if (canvas) {\n    targetCanvas = canvas;\n  } else {\n    targetCanvas = document.createElement('canvas');\n    targetCanvas.id = 'lumagl-canvas';\n    targetCanvas.style.width = Number.isFinite(width) ? `${width}px` : '100%';\n    targetCanvas.style.height = Number.isFinite(height) ? `${height}px` : '100%';\n    document.body.insertBefore(targetCanvas, document.body.firstChild);\n  }\n\n  return targetCanvas;\n}\n\nfunction logInfo(gl) {\n  const webGL = isWebGL2(gl) ? 'WebGL2' : 'WebGL1';\n  const info = getContextDebugInfo(gl);\n  const driver = info ? `(${info.vendor},${info.renderer})` : '';\n  const debug = gl.debug ? ' debug' : '';\n  log.info(1, `${webGL}${debug} context ${driver}`)();\n}\n\nfunction getVersion(gl) {\n  if (typeof WebGL2RenderingContext !== 'undefined' && gl instanceof WebGL2RenderingContext) {\n    // WebGL2 context.\n    return 2;\n  }\n  // Must be a WebGL1 context.\n  return 1;\n}\n\n// use devicePixelRatio to set canvas width and height\nfunction setDevicePixelRatio(gl, devicePixelRatio, options) {\n  // NOTE: if options.width and options.height not used remove in v8\n  let clientWidth = 'width' in options ? options.width : gl.canvas.clientWidth;\n  let clientHeight = 'height' in options ? options.height : gl.canvas.clientHeight;\n\n  if (!clientWidth || !clientHeight) {\n    log.log(1, 'Canvas clientWidth/clientHeight is 0')();\n    // by forcing devicePixel ratio to 1, we do not scale gl.canvas.width and height in each frame.\n    devicePixelRatio = 1;\n    clientWidth = gl.canvas.width || 1;\n    clientHeight = gl.canvas.height || 1;\n  }\n\n  gl.luma = gl.luma || {};\n  gl.luma.canvasSizeInfo = gl.luma.canvasSizeInfo || {};\n  const cachedSize = gl.luma.canvasSizeInfo;\n  // Check if canvas needs to be resized\n  if (\n    cachedSize.clientWidth !== clientWidth ||\n    cachedSize.clientHeight !== clientHeight ||\n    cachedSize.devicePixelRatio !== devicePixelRatio\n  ) {\n    let clampedPixelRatio = devicePixelRatio;\n\n    const canvasWidth = Math.floor(clientWidth * clampedPixelRatio);\n    const canvasHeight = Math.floor(clientHeight * clampedPixelRatio);\n    gl.canvas.width = canvasWidth;\n    gl.canvas.height = canvasHeight;\n\n    // Note: when devicePixelRatio is too high, it is possible we might hit system limit for\n    // drawing buffer width and hight, in those cases they get clamped and resulting aspect ration may not be maintained\n    // for those cases, reduce devicePixelRatio.\n    if (gl.drawingBufferWidth !== canvasWidth || gl.drawingBufferHeight !== canvasHeight) {\n      log.warn(`Device pixel ratio clamped`)();\n      clampedPixelRatio = Math.min(\n        gl.drawingBufferWidth / clientWidth,\n        gl.drawingBufferHeight / clientHeight\n      );\n\n      gl.canvas.width = Math.floor(clientWidth * clampedPixelRatio);\n      gl.canvas.height = Math.floor(clientHeight * clampedPixelRatio);\n    }\n\n    Object.assign(gl.luma.canvasSizeInfo, {clientWidth, clientHeight, devicePixelRatio});\n  }\n}\n"]},"metadata":{},"sourceType":"module"}